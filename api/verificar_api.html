<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificar API de Inferencias</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0"><i class="bi bi-check-circle me-2"></i>Verificador de API de Inferencias</h3>
            </div>
            <div class="card-body">
                <div id="resultados">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Verificando...</span>
                        </div>
                        <p class="mt-3">Verificando conexión con la API...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000';
        const resultados = document.getElementById('resultados');
        
        async function verificarAPI() {
            let html = '';
            
            // Test 1: Verificar que la API esté corriendo
            html += '<h5>1. Verificando que la API esté corriendo...</h5>';
            try {
                const response = await fetch(`${API_BASE_URL}/`);
                if (response.ok) {
                    const data = await response.json();
                    html += '<div class="alert alert-success">✅ API está corriendo correctamente</div>';
                    html += `<pre class="bg-light p-3 rounded">${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                html += `<div class="alert alert-danger">
                    ❌ Error: La API no está respondiendo<br>
                    <strong>Error:</strong> ${error.message}<br>
                    <strong>Solución:</strong> Ejecuta la API con: <code>cd api && python app.py</code>
                </div>`;
                resultados.innerHTML = html;
                return;
            }
            
            // Test 2: Probar endpoint de estadísticas
            html += '<hr><h5>2. Probando endpoint de estadísticas (alumno_id=2)...</h5>';
            try {
                const response = await fetch(`${API_BASE_URL}/api/estadisticas/2`);
                if (response.ok) {
                    const data = await response.json();
                    html += '<div class="alert alert-success">✅ Estadísticas obtenidas correctamente</div>';
                    html += `<pre class="bg-light p-3 rounded">${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
            } catch (error) {
                html += `<div class="alert alert-warning">⚠️ ${error.message}</div>`;
            }
            
            // Test 3: Probar endpoint de riesgo detallado
            html += '<hr><h5>3. Probando endpoint de riesgo detallado (alumno_id=2)...</h5>';
            try {
                const response = await fetch(`${API_BASE_URL}/api/riesgo/2/detallado`);
                if (response.ok) {
                    const data = await response.json();
                    html += '<div class="alert alert-success">✅ Análisis de riesgo obtenido correctamente</div>';
                    html += '<div class="card mt-3">';
                    html += '<div class="card-body">';
                    html += `<h6>Resumen:</h6>`;
                    html += `<ul>`;
                    html += `<li><strong>Nivel de Riesgo:</strong> ${data.analisis_riesgo?.nivel_riesgo || 'N/A'}</li>`;
                    html += `<li><strong>Score:</strong> ${data.analisis_riesgo?.score_riesgo || 'N/A'}</li>`;
                    html += `<li><strong>Reglas Aplicadas:</strong> ${data.analisis_riesgo?.reglas_aplicadas?.length || 0}</li>`;
                    html += `<li><strong>Recomendaciones:</strong> ${data.analisis_riesgo?.recomendaciones?.length || 0}</li>`;
                    html += `</ul>`;
                    html += `<details class="mt-3"><summary>Ver respuesta completa</summary>`;
                    html += `<pre class="bg-light p-3 rounded mt-2">${JSON.stringify(data, null, 2)}</pre>`;
                    html += `</details>`;
                    html += '</div></div>';
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
            } catch (error) {
                html += `<div class="alert alert-warning">⚠️ ${error.message}</div>`;
            }
            
            html += '<hr><div class="alert alert-info"><strong>✅ Verificación completada</strong><br>Si todos los tests pasaron, la API está funcionando correctamente.</div>';
            resultados.innerHTML = html;
        }
        
        // Ejecutar verificación al cargar
        verificarAPI();
    </script>
</body>
</html>

